---
title: "Frog lens transmission"
author: "Kate Thomas"
output: 
  html_document:
    toc_float: yes
---

```{r setup, include=FALSE}
# Packages
require(ggplot2)
require(plyr)
library(dplyr)
library(reshape2)
library(gridExtra)

# Directory
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

## Field data on lens and cornea transmission by expedition and species

### French Guiana (April 2018)
These data were collected in scope mode with the Avantes, and both a baseline (setup with no lens) and lens (blocking light path) spectrum were recorded for each lens/species. Plots show the raw data (top left), transmission spectrum (top right) and the adjusted transmission spectrum where the lens measurement is set to the baseline at 800 nm (bottom). These lenses were shipped back from French Guiana and we are currently working through them in Ron's lab; we will compare these fresh field measurements with those lab (frozen and thawed) measurements. 

```{r load-data-fg}
## Load data for measured frog specimens
fg <- data.frame(read.csv("../Data/frenchguiana.csv", na.strings=c("", "NA"))) #load raw data
```

```{r plot-fg, fig.height=10, fig.width=8}
## Plot transmission curves

#create a loop vector that matches column order (every odd column and the one next to it)
loop.vector<- seq(2,62,2) #creates a loop vector that's a sequence of all the lens columns (skipping the associated baseline columns and the wavelength column)

#make a loop for plotting and processing the data by species
for (i in loop.vector) {  #Loop over loop.vector
  x<-fg[ ,1] #stores wavelength as x
  lens<-fg[ ,i] #store lens data in lens
  base<-fg[ ,i+1]  #store baseline data in base (same species)
  adj_factor <- fg[which(fg$Wavelength==800.238), i+1]/fg[which(fg$Wavelength==800.238), i] # creates an adjustment factor to make lens transmission = baseline transmisison at 800 nm (divides baseline at 800nm by lens measurement at 800nm - actually 800.238 nm because it's the closest to 800 in our spec intervals)
  
  #Plot raw data for both curves
g1 <- ggplot(fg, aes(x)) +
  geom_point(aes(y=base, color="Baseline")) +
  geom_point(aes(y=lens, color="Lens")) +
  scale_colour_manual("Data", 
                      breaks = c("Baseline", "Lens"),
                      values = c("gray60", "black")) +
  theme_bw() +
  theme(legend.position = c(0.8, 0.8)) +
  ggtitle("Raw data") +
  xlab("Wavelength (nm)") +
  ylab("Scope units (raw detector reading)")

  #Plot measured transmission normalized by baseline
g2 <- ggplot(fg, aes(x)) +
  geom_point(aes(y=lens/base*100), alpha = 0.8) +
  xlab("Wavelength (nm)") +
  ylab("Transmission (%)") +
  xlim(c(350,750)) +
  ylim(c(0,150)) +
  ggtitle("Transmission") +
  theme_bw() +
  geom_hline(yintercept = 100, linetype="dashed")
  #ggtitle(colnames(fg[i]))

  #Plot measured transmission normalized and set to equal baseline at 800 nm 
g3 <- ggplot(fg, aes(x)) +
  geom_point(aes(y = (lens*adj_factor)/base*100), alpha = 0.8)+
  xlab("Wavelength (nm)") +
  ylab("Adjusted transmission (%)") +
  xlim(c(300, 800)) +
  ylim(c(0, 100)) +
  ggtitle("Adjusted transmission (800nm = 100%)") +
  theme_bw() +
  geom_hline(yintercept = 100, linetype = "dashed")
  #ggtitle(colnames(fg[i]))

# set title to the species ID in the column header
title = colnames(fg[i])

#Plot both panels
grid.arrange(g1, g2, g3, 
             top = title, 
             layout_matrix = rbind(c(1,2), c(3,3), c(3,3))) # produces plots with top two panels showing raw data and normalized to 100% data and bottom panel showing adjust transmission (baseline and lens set equal at 800nm)

} #end loop

```


### Australia (April 2018)

These are unsalvagable, as there is no baseline file recorded alongside the raw specimen measurements, so no way to determine lens transmission specturm. 

```{r load-data-aus, eval = FALSE}
## Load data for measured frog specimens
aus<-data.frame(read.csv("../Data/australia.csv", na.strings=c("", "NA", " "))) #load raw data
```

```{r plot-aus, eval = FALSE}
## Plot transmission curves

  #create the loop.vector 
loop.vector <- 2:15 #every column except the first, which is wavelength

for (i in loop.vector) {  #Loop over loop.vector
  x <- aus[ ,1] #stores wavelength as x
  lens <- aus[ ,i] #store lens data in lens
 
  #Plot data
print(ggplot(aus, aes(x))+
  geom_point(aes(y=lens))+
  xlab("Wavelength (nm)")+
  ylab("Transmission")+
  xlim(c(350,750))+
  theme_bw() +
  #ylim(c(0,150))+
  #geom_hline(yintercept = 100, linetype="dashed")+
  ggtitle(colnames(aus[i])))

  #Plot panel
#grid.arrange(aus, nrow=1)

} #end loop.

```

### Cornell data (July 2018)

These data were collected with the Avantes, with a lens spectrum and a baseline (no lens) reference measurement for each lens/species. These data look like the integration time was too high and oversaturated the sensor across most of the spectrum. Integration time needed to be knocked down to get usable data. *These lenses were frozen and we can re-do them in the lab once they are sent to NHM. 

```{r load-data-cor, eval = TRUE}
## Load data for measured frog specimens
cor<-data.frame(read.csv("../Data/cornell.csv", na.strings=c("", "NA", " "))) #load raw data
```

```{r plot-cor, eval = TRUE, fig.height=3.3, fig.width=8}
## Plot transmission curves

#create the loop.vector (every odd column and the one next to it)
loop.vector <- seq(2,4,2) #creates a loop vector that's a sequence of all the lens columns (skipping the associated baseline columns and the wavelength column)

for (i in loop.vector) {  #Loop over loop.vector
  x<-cor[ ,1] #stores wavelength as x
  lens<-cor[ ,i] #store lens data in lens
  base<-cor[ ,i+1]  #store baseline data in base (same species)
  
  #Plot raw data for both curves
g1 <- ggplot(cor, aes(x))+
  geom_point(aes(y=base, color="Baseline"))+
  geom_point(aes(y=lens, color="Lens"))+
  scale_colour_manual("Data", 
                      breaks = c("Baseline", "Lens"),
                      values = c("gray60", "black"))+
  theme_bw() +
  theme(legend.position = c(0.8, 0.8)) +
  xlab("Wavelength (nm)")+
  ylab("Scope units (raw detector reading)")

  #Plot measured transmission normalized by baseline
g2 <- ggplot(cor, aes(x))+
  geom_point(aes(y=lens/base*100))+
  xlab("Wavelength (nm)")+
  ylab("Normalized transmission (%)")+
  theme_bw() +
  #ggtitle("Species")+
  xlim(c(350,750))+
  ylim(c(0,150))+
  geom_hline(yintercept = 100, linetype="dashed")
  #ggtitle(colnames(cor[i]))

# set title to the species ID in the column header
title = colnames(cor[i])

#Plot both panels
grid.arrange(g1, g2, top = title, nrow=1)

} #end loop.

```

### Gabon data (July 2018)

These data appear to be unsalvagable. They were collected with a different spec (not the Avantes). There is one standard for all the lens measurements (file labeled lamp standard), though lenses were measured across several days. Unfortunately these data seem to be unsalvagable, as the lamp standard appears to be a red light that does not reach into the shorter wavelengths, which is the only place that lens filtering occurs. Thus, there is no transmission data for any of these specimens below ~450nm. 

```{r load-data-gabon, eval = TRUE}
## Load data for measured frog specimens
gabon<-data.frame(read.csv("../Data/gabon_edited.csv", na.strings=c("", "NA", " "))) #load raw data
``` 

```{r gabon-baseline, eval = TRUE, fig.cap="Light source for Gabon transmission measurements appears to be a red light with no intensity at short wavelengths."}
# Plot lamp standard spectrum
ggplot(gabon, aes(x = Wavelength..nm., y = lamp.standard_Intensity1))+
  geom_point() +
  theme_bw() +
  xlab("Wavelength (nm)")+
  ylab("Raw detector reading")
``` 

```{r plot-gabon, eval = FALSE}
## Plot transmission curves

#create the loop.vector (every odd column and the one next to it)

loop.vector<- seq(3,36,1) #creates a loop vector that's a sequence of all the lens columns (skipping the associated baseline columns and the wavelength column)

for (i in loop.vector) {  #Loop over loop.vector
  x<-gabon[ ,1] #stores wavelength as x
  lens<-gabon[ ,i] #store lens data in lens
  base<-gabon[ ,2]  #store baseline data in base (same species)
  
  #Plot raw data for both curves
g2<-ggplot(gabon, aes(x))+
  geom_point(aes(y=base, color="Baseline"))+
  geom_point(aes(y=lens, color="Lens"))+
  scale_colour_manual("Data", 
                      breaks = c("Baseline", "Lens"),
                      values = c("black", "coral1"))+
  theme(legend.position="top")+
  xlab("Wavelength (nm)")+
  ylab("Scope units (raw detector reading)")

  #Plot measured transmission normalized by baseline
g1<-ggplot(gabon, aes(x))+
  geom_point(aes(y=lens/base*100),color="purple")+
  xlab("Wavelength (nm)")+
  ylab("Normalized transmission (%)")+
  #ggtitle("Species")+
  xlim(c(350,750))+
  ylim(c(0,150))+
  geom_hline(yintercept = 100, linetype="dashed")+
  ggtitle(colnames(gabon[i]))

#Plot both panels
grid.arrange(g1, g2, nrow=1)

} #end loop.



#### Playing with data to try to figure out files:


x<-gabon[ ,1] #stores wavelength as x
lens<-gabon[ ,4] #store lens data in lens
base<-gabon[ ,3]  #store baseline data in base (same species)
  
#Plot raw data for both curves
ggplot(gabon, aes(x))+
  geom_point(aes(y=base, color="Baseline"))+
  geom_point(aes(y=lens, color="Lens"))+
  scale_colour_manual("Data", 
                      breaks = c("Baseline", "Lens"),
                      values = c("black", "coral1"))+
  theme(legend.position="top")+
  xlab("Wavelength (nm)")+
  ylab("Scope units (raw detector reading)")

#Plot measured transmission normalized by baseline
ggplot(gabon, aes(x))+
  geom_point(aes(y=lens/base*100),color="purple")+
  xlab("Wavelength (nm)")+
  ylab("Normalized transmission (%)")+
  #ggtitle("Species")+
  xlim(c(350,750))+
  ylim(c(0,150))+
  geom_hline(yintercept = 100, linetype="dashed")



```

### Natural History Museum (November 2018)

These lenses were measured the same way as in the field, and all frozen for re-analysis with Ron. 

```{r load-data-nhm}
## Load data for measured frog specimens
nhm<-data.frame(read.csv("../Data/nhm.csv", na.strings=c("", "NA", " "))) #load raw data
```

```{r plot-nhm, fig.height=10, fig.width=8}
## Plot transmission curves

#create the loop.vector (every odd column and the one next to it)

loop.vector<- seq(2,20,2) #creates a loop vector that's a sequence of all the lens columns (skipping the associated baseline columns and the wavelength column)
  
  #make a loop for plotting and processing the data by species
for (i in loop.vector) {  #Loop over loop.vector
  x <- nhm[ ,1] #stores wavelength as x
  lens <- nhm[ ,i] #store lens data in lens
  base <- nhm[ ,i+1]  #store baseline data in base (same species)
  adj_factor <- nhm[which(nhm$Wavelength==800.238), i+1]/nhm[which(nhm$Wavelength==800.238), i] # creates an adjustment factor to make lens transmission = baseline transmisison at 800 nm (divides baseline at 800nm by lens measurement at 800nm - actually 800.238 nm because it's the closest to 800 in our spec intervals)
  
  
  #Plot raw data for both curves
g1 <- ggplot(nhm, aes(x))+
  geom_point(aes(y=base, color="Baseline"))+
  geom_point(aes(y=lens, color="Lens"))+
  scale_colour_manual("Data", 
                      breaks = c("Baseline", "Lens"),
                      values = c("gray60", "black"))+
  ggtitle("Raw data") +
  theme_bw() +
  theme(legend.position = c(0.8, 0.8), legend.background = element_blank()) +
  xlab("Wavelength (nm)")+
  ylab("Scope units (raw detector reading)")

  #Plot measured transmission normalized by baseline
g2 <- ggplot(nhm, aes(x))+
  geom_point(aes(y=lens/base*100), alpha = 0.8)+
  xlab("Wavelength (nm)")+
  ylab("Transmission (%)")+
  ggtitle("Transmission") +
  theme_bw() +
  xlim(c(350,750))+
  ylim(c(0,150))+
  geom_hline(yintercept = 100, linetype="dashed")
  #ggtitle(colnames(nhm[i]))

  #Plot measured transmission normalized and set to equal baseline at 800 nm 
g3 <- ggplot(nhm, aes(x)) +
  geom_point(aes(y = (lens*adj_factor)/base*100), alpha = 0.8)+
  xlab("Wavelength (nm)") +
  ylab("Adjusted transmission (%)") +
  xlim(c(300, 800)) +
  ylim(c(0, 100)) +
  ggtitle("Adjusted transmission (800nm = 100%)") +
  theme_bw() +
  geom_hline(yintercept = 100, linetype = "dashed")
  #ggtitle(colnames(fg[i]))

# set title to the species ID in the column header
title = colnames(nhm[i])

#Plot both panels
grid.arrange(g1, g2, g3, 
             top = title, 
             layout_matrix = rbind(c(1,2), c(3,3), c(3,3))) # produces plots with top two panels showing raw data and normalized to 100% data and bottom panel showing adjust transmission (baseline and lens set equal at 800nm)

} #end loop

```

### Brazil (December 2018)

These lenses were not mesured in the field, but were frozen and we can measure them in the lab as soon as they are sent to NHM. 
